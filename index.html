<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หลักสูตร ฝอ.ตร. 47</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc;
        }
        .seat-card {
            aspect-ratio: 1 / 1.1;
            transition: all 0.2s ease-in-out;
        }
        .seat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        /* แอนิเมชันเรืองแสงสีทอง (ชาย) */
        .on-duty-glow {
            animation: pulse-amber 2s infinite;
            border-color: #f59e0b !important;
            background-color: #fffbeb !important;
        }
        @keyframes pulse-amber {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        /* แอนิเมชันเรืองแสงสีชมพู (หญิง) */
        .on-duty-pink-glow {
            animation: pulse-pink 2s infinite;
            border-color: #ec4899 !important;
            background-color: #fdf2f8 !important;
        }
        @keyframes pulse-pink {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }
        .modal-enter {
            animation: modalFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .grid-container::-webkit-scrollbar { height: 8px; }
        .grid-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .grid-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .classroom-grid {
            display: grid;
            grid-template-columns: 60px repeat(12, minmax(80px, 1fr));
            gap: 0.5rem;
            min-width: 1150px;
        }
        .info-pill { background: #f1f5f9; border-radius: 8px; padding: 8px 12px; border: 1px solid #e2e8f0; }
        .refresh-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* สไตล์ปุ่มเพลง */
        .music-widget { position: fixed; bottom: 2rem; right: 2rem; z-index: 100; }
        .music-pulse { animation: music-bounce 1.5s infinite; }
        @keyframes music-bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Footer Visibility */
        .footer-glow {
            box-shadow: 0 -20px 50px rgba(30, 58, 138, 0.15);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Audio Element -->
    <audio id="bgMusic" loop preload="auto">
        <source src="Sin Singular - เรื่องจริง Ost.คืนวันเสาร์[Official Audio].mp4" type="audio/mp4">
    </audio>

    <!-- Music Controller -->
    <div class="music-widget flex flex-col items-end">
        <button onclick="toggleMusic(event)" id="musicBtn" class="bg-blue-950 text-white p-5 rounded-full shadow-[0_15px_35px_rgba(0,0,0,0.4)] hover:bg-blue-900 transition-all flex items-center justify-center group ring-4 ring-white relative active:scale-90">
            <div id="musicStatusDot" class="absolute -top-1 -left-1 w-5 h-5 bg-red-500 border-2 border-white rounded-full transition-colors duration-500 shadow-sm"></div>
            <svg id="musicOnIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
            <svg id="musicOffIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </div>

    <!-- Header -->
    <header class="bg-blue-950 text-white pt-10 pb-16 shadow-xl sticky top-0 z-40 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-5xl font-black tracking-tight text-white mb-4 drop-shadow-lg">หลักสูตร ฝอ.ตร. 47</h1>
            
            <div class="inline-flex items-center bg-blue-900/60 px-6 py-2 rounded-full border border-blue-700 backdrop-blur-md shadow-inner">
                <span class="w-3 h-3 bg-green-400 rounded-full mr-3 animate-pulse shadow-[0_0_10px_#4ade80]"></span>
                <span id="todayDateDisplay" class="text-amber-400 font-extrabold text-sm md:text-lg tracking-wider">วันที่ ...</span>
            </div>
            
            <div class="max-w-2xl mx-auto mt-8 flex gap-3 px-2">
                <div class="relative group flex-grow">
                    <input type="text" id="searchInput" placeholder="ค้นหาชื่อ หรือชื่อเล่น..." 
                        class="w-full px-8 py-4 rounded-2xl border-none text-gray-800 focus:ring-4 focus:ring-blue-500 shadow-2xl transition-all pl-14 text-xl font-medium">
                    <div class="absolute left-5 top-4.5 text-gray-400 group-focus-within:text-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                <button onclick="refreshData()" id="refreshBtn" title="รีเฟรชข้อมูล" 
                    class="bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-2xl shadow-2xl transition-all active:scale-95 flex items-center justify-center border-b-4 border-blue-800">
                    <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 -mt-10 flex-grow mb-20 relative z-10">
        <div class="bg-white rounded-[3rem] shadow-2xl p-8 md:p-12 border border-slate-100 footer-glow">
            <div class="w-full bg-gradient-to-r from-slate-900 to-slate-700 py-5 mb-14 rounded-2xl text-center text-white font-black tracking-[1em] shadow-xl border-b-4 border-blue-600 uppercase text-xs md:text-sm">
                หน้าชั้นเรียน / วิทยากร
            </div>

            <div class="grid-container overflow-x-auto pb-10">
                <div id="seatingGrid" class="classroom-grid">
                    <div class="col-span-full text-center py-32">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-900 border-t-transparent shadow-lg"></div>
                        <p class="mt-6 text-slate-500 font-black text-lg animate-pulse">กำลังซิงค์ข้อมูลล่าสุดจาก Google Sheets...</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 flex flex-wrap justify-center gap-8 text-xs md:text-sm text-slate-500 border-t border-slate-100 pt-10 uppercase font-black tracking-widest">
                <div class="flex items-center"><span class="w-4 h-4 bg-white border-2 border-slate-200 rounded-lg mr-3"></span> ปกติ</div>
                <div class="flex items-center"><span class="w-4 h-4 bg-amber-400 border-2 border-amber-600 rounded-lg mr-3 shadow-sm"></span> เวรประจำวัน (ช)</div>
                <div class="flex items-center"><span class="w-4 h-4 bg-pink-400 border-2 border-pink-600 rounded-lg mr-3 shadow-sm"></span> เวรประจำวัน (ญ)</div>
                <div class="flex items-center text-blue-900 animate-bounce ml-4 font-extrabold italic">* คลิกที่รูปเพื่อดูรายละเอียด</div>
            </div>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-slate-950 text-white py-20 border-t-[12px] border-blue-900 relative overflow-hidden mt-auto">
        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-px bg-gradient-to-r from-transparent via-blue-500 to-transparent"></div>
        
        <div class="container mx-auto px-4 text-center relative z-10">
            <div class="mb-14">
                <div class="inline-flex items-center justify-center bg-blue-600/20 px-8 py-2.5 rounded-full border-2 border-blue-500/50 mb-6 shadow-[0_0_20px_rgba(37,99,235,0.2)]">
                    <span class="text-blue-400 font-black text-sm md:text-base uppercase tracking-[0.5em]">ผู้จัดทำระบบ</span>
                </div>
                <h2 class="text-5xl md:text-7xl font-extrabold tracking-tighter mb-8 text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-slate-500">
                    ร.ต.อ.กันย์ บุญก่อน
                </h2>
                
                <div class="flex flex-col items-center gap-8">
                    <a href="tel:0615594499" class="group relative flex items-center bg-blue-600 hover:bg-white px-12 py-6 rounded-[2.5rem] transition-all shadow-[0_25px_60px_rgba(0,0,0,0.6)] hover:-translate-y-3 active:scale-95 border-b-8 border-blue-800 hover:border-slate-300">
                        <div class="w-16 h-16 bg-blue-800 rounded-3xl flex items-center justify-center mr-6 text-white group-hover:bg-blue-600 transition-colors shadow-2xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 005.405 5.405l.773-1.548a1 1 0 011.06-.538l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                            </svg>
                        </div>
                        <span class="text-4xl md:text-5xl font-black tracking-tighter text-white group-hover:text-blue-900 transition-colors">061-559-4499</span>
                    </a>
                </div>
            </div>

            <div class="max-w-4xl mx-auto bg-slate-900/80 p-10 md:p-12 rounded-[3.5rem] border-2 border-white/10 shadow-3xl backdrop-blur-2xl relative">
                <div class="absolute -top-5 left-1/2 -translate-x-1/2 bg-amber-500 text-black px-8 py-1.5 rounded-full font-black text-sm uppercase tracking-[0.3em] shadow-xl">
                    ประกาศสำคัญ
                </div>
                <p class="text-lg md:text-2xl leading-relaxed text-slate-100 font-bold">
                    หากท่านต้องการให้แก้ไข ลบ เพิ่มเติมข้อมูลส่วนใด <br class="hidden md:block">
                    สามารถโทรติดต่อได้โดยตรง หรือติดต่อผ่านแอปพลิเคชันไลน์ 
                    <span class="block mt-4 text-3xl md:text-4xl text-green-400 font-black tracking-tight drop-shadow-[0_0_15px_rgba(74,222,128,0.3)] hover:text-green-300 cursor-pointer transition-colors">LINE ID: gunbazaz</span>
                </p>
            </div>

            <p class="mt-20 text-[11px] font-bold text-slate-700 uppercase tracking-[1em] opacity-30">
                © 2026 หลักสูตร ฝอ.ตร. 47 | POLICE STAFF COURSE SYSTEM
            </p>
        </div>
    </footer>

    <!-- Detailed Profile Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all text-white">
        <div class="bg-white w-full max-w-lg rounded-[3rem] shadow-2xl overflow-hidden modal-enter flex flex-col max-h-[92vh]">
            <div id="modalHeader" class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 p-10 relative transition-colors duration-500">
                <div id="modalDutyIndicator" class="absolute top-8 left-8 hidden">
                    <span id="modalDutyBadge" class="flex items-center text-blue-900 px-4 py-2 rounded-full text-[11px] font-black shadow-xl ring-4 ring-white animate-bounce uppercase tracking-widest">
                        เข้าเวรวันนี้
                    </span>
                </div>
                <button onclick="closeModal()" class="absolute top-8 right-8 text-white/40 hover:text-white hover:bg-white/10 p-2.5 rounded-full transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="flex flex-col items-center">
                    <div class="relative group">
                        <div id="modalRing" class="absolute inset-0 bg-blue-400 rounded-[2.5rem] blur opacity-20 transition-all duration-700"></div>
                        <div id="modalProfileImgContainer" class="relative w-40 h-40 md:w-48 md:h-48 rounded-[2.5rem] overflow-hidden border-4 border-white shadow-2xl bg-slate-100 flex items-center justify-center">
                            <img id="modalImg" src="" alt="Profile" class="w-full h-full object-cover hidden">
                            <div id="modalPlaceholderIcon" class="w-full h-full flex items-center justify-center scale-150"></div>
                        </div>
                        <div id="modalSeatNum" class="absolute -bottom-5 -right-5 bg-yellow-400 text-blue-950 font-black px-5 py-2 rounded-2xl shadow-2xl border-4 border-white text-base">#00</div>
                    </div>
                    <h2 id="modalFullName" class="text-3xl md:text-4xl font-black mt-10 mb-2 text-center tracking-tight text-white leading-tight">...</h2>
                    <p id="modalNickname" class="text-blue-200 font-bold italic text-2xl text-center">...</p>
                </div>
            </div>
            <div class="overflow-y-auto p-10 space-y-8 text-gray-800 text-left">
                <section id="modalDutyBox" class="hidden">
                    <div id="modalDutyAlert" class="border-2 p-6 rounded-3xl flex items-center shadow-lg">
                        <div id="modalDutyIconBg" class="w-14 h-14 rounded-2xl flex items-center justify-center mr-5 text-white shadow-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-black text-xs uppercase tracking-[0.2em] mb-1 text-amber-900">ภารกิจวันนี้</h4>
                            <p id="modalDutyLabel" class="font-extrabold text-2xl text-amber-700 leading-tight">เวรประจำวัน</p>
                        </div>
                    </div>
                </section>
                <section>
                    <h3 class="flex items-center text-blue-950 font-black text-sm uppercase tracking-widest mb-5">
                        <span class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center mr-4 text-blue-700 shadow-sm font-black">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                            </svg>
                        </span>ข้อมูลตำแหน่งและติดต่อ
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="info-pill flex flex-col items-start"><label class="text-[11px] uppercase text-slate-400 font-black mb-1 tracking-tighter">ตำแหน่งปัจจุบัน</label><span id="modalPosition" class="text-slate-700 font-bold text-lg leading-tight">-</span></div>
                        <div class="info-pill flex flex-col items-start"><label class="text-[11px] uppercase text-slate-400 font-black mb-1 tracking-tighter">เบอร์โทรศัพท์</label><span id="modalPhone" class="text-blue-800 font-black text-xl">-</span></div>
                    </div>
                </section>
                <section>
                    <h3 class="flex items-center text-blue-950 font-black text-sm uppercase tracking-widest mb-5 italic">ความรู้สึกที่อยากบอกเพื่อนๆ</h3>
                    <div class="bg-blue-50/50 p-8 rounded-[2rem] border-2 border-blue-100/50 italic text-blue-900 leading-relaxed font-bold text-xl relative overflow-hidden">
                        <div class="absolute -top-2 -left-2 opacity-5 text-blue-900 scale-[4]">"</div>
                        <p id="modalMessage" class="relative z-10">"-"</p>
                    </div>
                </section>
                <button onclick="closeModal()" class="w-full bg-blue-950 text-white py-5 rounded-3xl font-black text-xl hover:bg-blue-900 transition-all shadow-2xl border-b-4 border-slate-900">กลับหน้าผังที่นั่ง</button>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJUfNHvOshKc8afyHvk_aJubIjzr5Z1kysOYilI2FQmqu2zMn2kkah3y53X9BgnE0voLwuwplHbB3/pub?output=csv';
        let studentData = [];
        const SEATS_PER_ROW = 12;

        const MALE_ICON = `<svg xmlns="http://www.w3.org/2000/svg" class="w-3/4 h-3/4 text-slate-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>`;
        const FEMALE_ICON = `<svg xmlns="http://www.w3.org/2000/svg" class="w-3/4 h-3/4 text-pink-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/><path d="M12 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" opacity=".3"/></svg>`;

        /**
         * Enhanced Music Logic - Fix Play/Pause interruption
         */
        const audio = document.getElementById('bgMusic');
        let isMusicPlaying = false;
        let musicStarted = false;
        let audioPromise = null;

        function toggleMusic(e) {
            if (e) e.stopPropagation();
            
            const onIcon = document.getElementById('musicOnIcon');
            const offIcon = document.getElementById('musicOffIcon');
            const btn = document.getElementById('musicBtn');
            const statusDot = document.getElementById('musicStatusDot');

            if (audio.paused) {
                // เก็บ Promise เพื่อเช็คสถานะการเล่น
                audioPromise = audio.play();
                
                if (audioPromise !== undefined) {
                    audioPromise.then(() => {
                        onIcon.classList.add('hidden');
                        offIcon.classList.remove('hidden');
                        btn.classList.replace('bg-blue-950', 'bg-green-600');
                        btn.classList.add('music-pulse');
                        statusDot.classList.replace('bg-red-500', 'bg-green-400');
                        isMusicPlaying = true;
                        musicStarted = true;
                    }).catch(err => {
                        // จัดการกรณี Error เบราว์เซอร์บล็อก
                        console.log("Music play blocked:", err);
                    });
                }
            } else {
                // รอให้ Play Promise เสร็จสิ้นก่อนค่อยสั่ง Pause (ถ้ามี)
                if (audioPromise !== null) {
                    audioPromise.then(() => {
                        audio.pause();
                        updateMusicUI(false);
                    });
                } else {
                    audio.pause();
                    updateMusicUI(false);
                }
            }
        }

        function updateMusicUI(playing) {
            const onIcon = document.getElementById('musicOnIcon');
            const offIcon = document.getElementById('musicOffIcon');
            const btn = document.getElementById('musicBtn');
            const statusDot = document.getElementById('musicStatusDot');

            if (!playing) {
                onIcon.classList.remove('hidden');
                offIcon.classList.add('hidden');
                btn.classList.replace('bg-green-600', 'bg-blue-950');
                btn.classList.remove('music-pulse');
                statusDot.classList.replace('bg-green-400', 'bg-red-500');
                isMusicPlaying = false;
            }
        }

        document.addEventListener('click', function(e) {
            if (!musicStarted && e.target.closest('#musicBtn') === null) {
                toggleMusic();
            }
        }, { once: true });

        function getVal(row, headerName) {
            if (!row || !headerName) return null;
            const keys = Object.keys(row);
            const targetKey = keys.find(k => k.trim() === headerName.trim());
            return targetKey ? row[targetKey] : null;
        }

        function getDutyDateString() {
            const now = new Date();
            return `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
        }

        function checkDuty(student) {
            const todayStr = getDutyDateString();
            const dutyContent = getVal(student, "เวรทั่วไป/เวรต้อนรับ");
            if (!dutyContent) return null;
            const variations = [todayStr, `${new Date().getDate().toString().padStart(2, '0')}/${(new Date().getMonth() + 1).toString().padStart(2, '0')}/${new Date().getFullYear()}`];
            for (const v of variations) { if (dutyContent.toString().includes(v)) return true; }
            return null;
        }

        function formatDriveLink(url) {
            if (!url || typeof url !== 'string') return "";
            if (url.includes("drive.google.com")) {
                let fileId = (url.includes("id=")) ? url.split("id=")[1].split("&")[0] : url.split("/d/")[1].split("/")[0];
                return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            return url;
        }

        function initApp() {
            const dateStr = getDutyDateString();
            document.getElementById('todayDateDisplay').innerText = `วันที่ ${dateStr}`;
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    studentData = results.data.filter(row => getVal(row, 'ชื่อ') && getVal(row, 'ชื่อ').trim() !== "");
                    renderGrid(studentData);
                    stopRefreshAnimation();
                },
                error: function() { stopRefreshAnimation(); }
            });
        }

        function refreshData() {
            document.getElementById('refreshIcon').classList.add('refresh-spin');
            initApp();
        }

        function stopRefreshAnimation() { document.getElementById('refreshIcon').classList.remove('refresh-spin'); }

        function renderGrid(data, filter = '') {
            const grid = document.getElementById('seatingGrid');
            grid.innerHTML = '';
            const totalRows = Math.ceil(data.length / SEATS_PER_ROW);
            for (let r = 0; r < totalRows; r++) {
                const rowLabel = document.createElement('div');
                rowLabel.className = "flex items-center justify-center font-black text-blue-900 bg-blue-50/80 rounded-xl text-[10px] md:text-xs shadow-inner border-2 border-blue-100 uppercase tracking-tighter mb-1";
                rowLabel.innerHTML = `แถว<br>${r + 1}`;
                grid.appendChild(rowLabel);
                for (let c = 0; c < SEATS_PER_ROW; c++) {
                    const idx = (r * SEATS_PER_ROW) + c;
                    const student = data[idx];
                    if (student) {
                        const isFemale = (getVal(student, 'ยศ') || "").includes("หญิง");
                        const hasDuty = checkDuty(student);
                        const isMatch = filter === '' || JSON.stringify(student).toLowerCase().includes(filter.toLowerCase());
                        let dutyClass = hasDuty ? (isFemale ? 'on-duty-pink-glow' : 'on-duty-glow') : 'border-slate-100';
                        const seatDiv = document.createElement('div');
                        seatDiv.className = `seat-card relative bg-white rounded-2xl shadow-sm flex flex-col items-center justify-center p-2 cursor-pointer border-2 transition-all ${dutyClass} ${isMatch ? 'hover:border-blue-500' : 'opacity-10 grayscale scale-90 pointer-events-none'}`;
                        const profileImg = getVal(student, 'รูปภาพประกอบ') || getVal(student, 'รูปภาพ') || student['Link'];
                        seatDiv.innerHTML = `
                            <span class="absolute top-1.5 left-2 text-[8px] text-slate-400 font-black italic">#${idx+1}</span>
                            ${hasDuty ? `<div class="absolute -top-2.5 -right-1.5 z-20 ${isFemale ? 'bg-pink-500' : 'bg-amber-500'} text-white rounded-full p-1.5 shadow-xl border-2 border-white animate-bounce"><svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg></div>` : ''}
                            <div class="w-11 h-11 md:w-16 md:h-16 rounded-[1rem] overflow-hidden border border-slate-100 mb-2 bg-slate-50 flex items-center justify-center shadow-inner">
                                ${profileImg ? `<img src="${formatDriveLink(profileImg)}" class="w-full h-full object-cover">` : (isFemale ? FEMALE_ICON : MALE_ICON)}
                            </div>
                            <div class="text-[8px] md:text-[11px] font-black ${hasDuty ? (isFemale ? 'text-pink-700' : 'text-amber-800') : 'text-blue-950'} text-center truncate w-full px-1">คุณ${(getVal(student, 'ชื่อเล่น') || getVal(student, 'ชื่อ') || "บุคคล") }</div>`;
                        seatDiv.onclick = () => showModal(student, idx+1, hasDuty, isFemale);
                        grid.appendChild(seatDiv);
                    } else {
                        grid.innerHTML += `<div class="seat-card bg-slate-50/50 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center text-[10px] text-slate-300 font-black">ว่าง</div>`;
                    }
                }
            }
        }

        function showModal(student, seatNum, hasDuty, isFemale) {
            const firstName = (getVal(student, 'ชื่อ') || "").trim();
            document.getElementById('modalFullName').innerText = `${getVal(student, 'ยศ') || ""}${firstName} ${getVal(student, 'นามสกุล') || ""}`;
            document.getElementById('modalNickname').innerText = getVal(student, 'ชื่อเล่น') ? `ชื่อเล่น: ${getVal(student, 'ชื่อเล่น')}` : 'ชื่อเล่น: -';
            document.getElementById('modalPosition').innerText = getVal(student, 'ตำแหน่ง') || '-';
            document.getElementById('modalPhone').innerText = getVal(student, 'เบอร์โทร') || getVal(student, 'เบอร์โทรศัพท์') || '-';
            document.getElementById('modalMessage').innerText = getVal(student, 'อยากจะบอกอะไรกับเพื่อนๆ') || '-';
            document.getElementById('modalSeatNum').innerText = `ที่นั่ง #${seatNum}`;
            
            const profileImg = getVal(student, 'รูปภาพประกอบ') || getVal(student, 'รูปภาพ') || student['Link'];
            const modalImg = document.getElementById('modalImg');
            const placeholderIcon = document.getElementById('modalPlaceholderIcon');
            if(profileImg) { modalImg.src = formatDriveLink(profileImg); modalImg.classList.remove('hidden'); placeholderIcon.innerHTML = ''; }
            else { modalImg.classList.add('hidden'); placeholderIcon.innerHTML = isFemale ? FEMALE_ICON : MALE_ICON; }

            const header = document.getElementById('modalHeader');
            const dutyBox = document.getElementById('modalDutyBox');
            if (hasDuty) {
                document.getElementById('modalDutyIndicator').classList.remove('hidden');
                dutyBox.classList.remove('hidden');
                header.className = isFemale ? "bg-gradient-to-br from-pink-800 via-pink-700 to-rose-900 p-10 relative transition-all text-white" : "bg-gradient-to-br from-amber-800 via-amber-700 to-orange-900 p-10 relative transition-all text-white text-white";
                document.getElementById('modalDutyAlert').className = isFemale ? "border-2 p-6 rounded-3xl flex items-center shadow-lg bg-pink-50 border-pink-200" : "border-2 p-6 rounded-3xl flex items-center shadow-lg bg-amber-50 border-amber-200";
                document.getElementById('modalDutyIconBg').className = isFemale ? "w-14 h-14 rounded-2xl flex items-center justify-center mr-5 text-white shadow-xl bg-pink-500" : "w-14 h-14 rounded-2xl flex items-center justify-center mr-5 text-white shadow-xl bg-amber-500";
            } else {
                document.getElementById('modalDutyIndicator').classList.add('hidden');
                dutyBox.classList.add('hidden');
                header.className = "bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 p-10 relative transition-all text-white";
            }
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        document.getElementById('searchInput').addEventListener('input', (e) => { renderGrid(studentData, e.target.value); });
        window.onclick = function(e) { if (e.target.id === 'modalOverlay') closeModal(); }
        window.onload = initApp;
    </script>
</body>
</html>
