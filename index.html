<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หลักสูตร ฝอ.ตร. 47</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc;
        }
        .seat-card {
            aspect-ratio: 1 / 1.1;
            transition: all 0.2s ease-in-out;
        }
        .seat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        /* แอนิเมชันเรืองแสงสีทอง (ชาย) */
        .on-duty-glow {
            animation: pulse-amber 2s infinite;
            border-color: #f59e0b !important;
            background-color: #fffbeb !important;
        }
        @keyframes pulse-amber {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        /* แอนิเมชันเรืองแสงสีชมพู (หญิง) */
        .on-duty-pink-glow {
            animation: pulse-pink 2s infinite;
            border-color: #ec4899 !important;
            background-color: #fdf2f8 !important;
        }
        @keyframes pulse-pink {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }
        .modal-enter {
            animation: modalFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .grid-container::-webkit-scrollbar {
            height: 8px;
        }
        .grid-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .grid-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .classroom-grid {
            display: grid;
            grid-template-columns: 60px repeat(12, minmax(80px, 1fr));
            gap: 0.5rem;
            min-width: 1150px;
        }
        .info-pill {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
        }
        .refresh-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Canvas Styles */
        #drawingCanvas {
            touch-action: none;
            cursor: crosshair;
            background-color: #ffffff;
            border-radius: 1rem;
        }
        .tool-btn {
            transition: all 0.2s;
        }
        .tool-btn:active {
            transform: scale(0.9);
        }
    </style>
</head>
<body class="pb-20">

    <!-- Hero Banner Section -->
    <div class="w-full h-48 md:h-72 overflow-hidden relative shadow-lg">
        <img src="https://lh3.googleusercontent.com/d/1dSVj8D0LjJ0ArXvjqsMdna9tqA8OnEOB" 
             alt="Banner หลักสูตร ฝอ.ตร. 47" 
             class="w-full h-full object-cover object-center"
             onerror="this.src='https://www.transparenttextures.com/patterns/cubes.png'; this.parentElement.classList.add('bg-blue-950')">
        <div class="absolute inset-0 bg-gradient-to-t from-blue-950 via-blue-950/20 to-transparent"></div>
    </div>

    <!-- Header Section -->
    <header class="bg-blue-950 text-white pb-12 shadow-xl sticky top-0 z-40 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] -mt-1">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight text-white pt-4">หลักสูตร ฝอ.ตร. 47</h1>
            
            <div class="mt-3 inline-flex items-center bg-blue-900/50 px-4 py-1.5 rounded-full border border-blue-800 backdrop-blur-sm">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                <span id="todayDateDisplay" class="text-amber-400 font-bold text-xs md:text-sm tracking-wide">
                    วันที่ ...
                </span>
            </div>
            
            <div class="max-w-xl mx-auto mt-6 flex gap-2 px-2">
                <div class="relative group flex-grow">
                    <input type="text" id="searchInput" placeholder="ค้นหาด้วย เลขที่, ชื่อ หรือชื่อเล่น..." 
                        class="w-full px-6 py-3 rounded-full border-none text-gray-800 focus:ring-4 focus:ring-blue-500 shadow-2xl transition-all pl-12 text-lg">
                    <div class="absolute left-4 top-3.5 text-gray-400 group-focus-within:text-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                <button onclick="refreshData()" id="refreshBtn" title="รีเฟรชข้อมูล" 
                    class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-full shadow-2xl transition-all active:scale-95 flex items-center justify-center">
                    <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 -mt-6 space-y-8">
        <!-- Section 1: Seating Grid -->
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8">
            <div class="w-full bg-gradient-to-r from-slate-800 to-slate-700 py-4 mb-12 rounded-xl text-center text-white font-bold tracking-[0.8em] shadow-lg border-b-4 border-blue-500 uppercase text-sm">
                หน้าชั้นเรียน / วิทยากร
            </div>

            <div class="grid-container overflow-x-auto pb-6">
                <div id="seatingGrid" class="classroom-grid">
                    <div class="col-span-full text-center py-24">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-900 border-t-transparent"></div>
                        <p class="mt-4 text-slate-500 font-bold animate-pulse">กำลังโหลดผังที่นั่งและตารางเวร...</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex flex-wrap justify-center gap-6 text-[10px] md:text-xs text-slate-500 border-t pt-6 uppercase font-bold tracking-wider">
                <div class="flex items-center"><span class="w-3 h-3 bg-white border border-blue-200 rounded mr-2"></span> ปกติ (ชาย)</div>
                <div class="flex items-center"><span class="w-3 h-3 bg-white border border-pink-200 rounded mr-2"></span> ปกติ (หญิง)</div>
                <div class="flex items-center"><span class="w-3 h-3 bg-amber-400 border border-amber-600 rounded mr-2"></span> เวรประจำวัน (ช)</div>
                <div class="flex items-center"><span class="w-3 h-3 bg-pink-400 border border-pink-600 rounded mr-2"></span> เวรประจำวัน (ญ)</div>
                <div class="flex items-center text-blue-900 animate-bounce">* คลิกที่รูปเพื่อดูรายละเอียด</div>
            </div>
        </div>

        <!-- Section 2: Drawing Canvas -->
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-black text-blue-950 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        กระดานลงนาม / บันทึกความจำ
                    </h2>
                    <p class="text-slate-500 text-sm mt-1">ใช้สำหรับลงลายมือชื่อหรือเขียนข้อความสั้นๆ เพื่อแจ้งข่าวสาร</p>
                </div>
                
                <div class="flex flex-wrap items-center gap-3 bg-slate-100 p-2 rounded-2xl border border-slate-200">
                    <input type="color" id="canvasColor" value="#1e3a8a" class="w-10 h-10 rounded-lg cursor-pointer border-none bg-transparent">
                    
                    <select id="canvasSize" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 font-bold">
                        <option value="2">เส้นเล็ก</option>
                        <option value="5" selected>เส้นกลาง</option>
                        <option value="10">เส้นหนา</option>
                        <option value="20">หัวแปรงใหญ่</option>
                    </select>

                    <button onclick="clearCanvas()" class="tool-btn bg-rose-100 hover:bg-rose-200 text-rose-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        ล้างกระดาน
                    </button>

                    <button onclick="downloadCanvas()" class="tool-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center shadow-lg shadow-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        บันทึกภาพ
                    </button>
                </div>
            </div>

            <div id="canvasContainer" class="w-full bg-slate-200 rounded-[1.5rem] p-1 shadow-inner border-2 border-slate-300">
                <canvas id="drawingCanvas" class="w-full h-[400px]"></canvas>
            </div>
        </div>
    </main>

    <!-- Detailed Profile Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden modal-enter flex flex-col max-h-[92vh]">
            
            <div id="modalHeader" class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 p-8 relative transition-colors duration-500">
                <div id="modalDutyIndicator" class="absolute top-6 left-6 hidden">
                    <span id="modalDutyBadge" class="flex items-center text-blue-900 px-3 py-1.5 rounded-full text-[10px] font-black shadow-xl ring-2 ring-white animate-bounce">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        เข้าเวรวันนี้
                    </span>
                </div>

                <button onclick="closeModal()" class="absolute top-6 right-6 text-white/50 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                
                <div class="flex flex-col items-center">
                    <div class="relative group">
                        <div id="modalRing" class="absolute inset-0 bg-blue-400 rounded-3xl blur opacity-20 transition-all duration-500"></div>
                        <div id="modalProfileImgContainer" class="relative w-36 h-36 md:w-44 md:h-44 rounded-3xl overflow-hidden border-4 border-white shadow-2xl bg-slate-100 flex items-center justify-center">
                            <img id="modalImg" src="" alt="Police Profile" class="w-full h-full object-cover hidden">
                            <div id="modalPlaceholderIcon" class="w-full h-full flex items-center justify-center"></div>
                        </div>
                        <div id="modalSeatNum" class="absolute -bottom-4 -right-4 bg-yellow-400 text-blue-950 font-black px-4 py-1.5 rounded-2xl shadow-xl border-4 border-white text-sm">
                            #00
                        </div>
                    </div>
                    <h2 id="modalFullName" class="text-2xl md:text-3xl font-black text-white mt-8 mb-1 text-center tracking-tight">ยศ ชื่อ นามสกุล</h2>
                    <p id="modalNickname" class="text-blue-200 font-bold italic text-xl text-center">ชื่อเล่น: -</p>
                </div>
            </div>
            
            <div class="overflow-y-auto p-8 space-y-6 text-gray-800">
                <section>
                    <h3 class="flex items-center text-blue-900 font-extrabold text-sm uppercase tracking-widest mb-4">
                        <span class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center mr-3 text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        ข้อมูลส่วนตัวและตำแหน่ง
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="info-pill">
                            <label class="text-[10px] uppercase text-slate-400 font-black block mb-0.5">ตำแหน่งปัจจุบัน</label>
                            <span id="modalPosition" class="text-slate-700 font-bold">-</span>
                        </div>
                        <div class="info-pill">
                            <label class="text-[10px] uppercase text-slate-400 font-black block mb-0.5">เบอร์โทรศัพท์</label>
                            <span id="modalPhone" class="text-blue-700 font-black">-</span>
                        </div>
                        <div class="info-pill">
                            <label class="text-[10px] uppercase text-slate-400 font-black block mb-0.5 flex items-center">
                                <svg class="w-3.5 h-3.5 mr-1 text-pink-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                                Instagram (IG)
                            </label>
                            <span id="modalIG" class="text-pink-600 font-black tracking-tight">-</span>
                        </div>
                        <div class="info-pill">
                            <label class="text-[10px] uppercase text-slate-400 font-black block mb-0.5">สถานะ</label>
                            <span id="modalStatus" class="text-blue-800 font-bold">-</span>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="flex items-center text-blue-900 font-extrabold text-sm uppercase tracking-widest mb-4">
                        <span class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center mr-3 text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                        </span>
                        อยากจะบอกอะไรกับเพื่อนๆ
                    </h3>
                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 text-blue-900 leading-relaxed font-medium relative">
                        <p id="modalMessage" class="whitespace-pre-line text-sm md:text-base italic">"-"</p>
                    </div>
                </section>

                <button onclick="closeModal()" class="w-full bg-blue-950 text-white py-4 rounded-2xl font-black text-lg hover:bg-blue-900 transition-all shadow-xl active:scale-[0.98] mt-4">
                    กลับหน้าผังที่นั่ง
                </button>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJUfNHvOshKc8afyHvk_aJubIjzr5Z1kysOYilI2FQmqu2zMn2kkah3y53X9BgnE0voLwuwplHbB3/pub?output=csv';
        let studentData = [];
        const SEATS_PER_ROW = 12;

        const MALE_ICON = `<svg xmlns="http://www.w3.org/2000/svg" class="w-3/4 h-3/4 text-slate-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>`;
        const FEMALE_ICON = `<svg xmlns="http://www.w3.org/2000/svg" class="w-3/4 h-3/4 text-pink-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/><path d="M12 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" opacity=".3"/></svg>`;

        // ฟังก์ชันดึงค่าจาก Header แบบยืดหยุ่น (แก้ปัญหาเว้นวรรคหรือพิมพ์เล็กใหญ่)
        function getVal(row, headerName) {
            if (!row || !headerName) return null;
            const keys = Object.keys(row);
            // ค้นหาหัวข้อที่ใกล้เคียงที่สุด (Trim และ Lowercase ทั้งคู่)
            const targetKey = keys.find(k => k.trim().toLowerCase() === headerName.trim().toLowerCase());
            return targetKey ? row[targetKey] : null;
        }

        function getDutyDateString() {
            const now = new Date();
            const d = now.getDate();
            const m = now.getMonth() + 1;
            const y = now.getFullYear();
            return `${d}/${m}/${y}`;
        }

        function checkDuty(student) {
            const todayStr = getDutyDateString();
            const dutyContent = getVal(student, "เวรทั่วไป/เวรต้อนรับ");
            if (!dutyContent) return null;
            const contentStr = dutyContent.toString().trim();
            return contentStr.includes(todayStr) ? true : null;
        }

        function formatDriveLink(url) {
            if (!url || typeof url !== 'string') return "";
            if (url.includes("drive.google.com")) {
                let fileId = "";
                if (url.includes("id=")) {
                    fileId = url.split("id=")[1].split("&")[0];
                } else if (url.includes("/d/")) {
                    fileId = url.split("/d/")[1].split("/")[0];
                }
                if (fileId) return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            return url;
        }

        function getImageUrl(student) {
            const imgLink = getVal(student, 'รูปภาพประกอบ') || getVal(student, 'รูปภาพ') || student['Link'];
            return formatDriveLink(imgLink);
        }

        function initApp() {
            const now = new Date();
            document.getElementById('todayDateDisplay').innerText = `วันที่ ${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
            
            const grid = document.getElementById('seatingGrid');
            grid.innerHTML = `<div class="col-span-full text-center py-24"><div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-900 border-t-transparent"></div><p class="mt-4 text-slate-500 font-bold animate-pulse">กำลังโหลดข้อมูล...</p></div>`;

            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // กรองเฉพาะแถวที่มีข้อมูลชื่อเท่านั้น (ป้องกันแถวว่างท้ายตาราง)
                    studentData = results.data.filter(row => {
                        const name = getVal(row, 'ชื่อ');
                        return name && name.toString().trim() !== "";
                    });
                    renderGrid(studentData);
                    stopRefreshAnimation();
                }
            });
            setupCanvas();
        }

        function renderGrid(data, filter = '') {
            const grid = document.getElementById('seatingGrid');
            grid.innerHTML = '';
            const totalRows = Math.ceil(data.length / SEATS_PER_ROW);
            const filterQuery = filter.toLowerCase().trim();

            for (let r = 0; r < totalRows; r++) {
                const rowLabel = document.createElement('div');
                rowLabel.className = "flex items-center justify-center font-black text-blue-900 bg-blue-50 rounded-lg text-[10px] shadow-inner border border-blue-200";
                rowLabel.innerHTML = `แถว<br>${r + 1}`;
                grid.appendChild(rowLabel);

                for (let c = 0; c < SEATS_PER_ROW; c++) {
                    const studentIdx = (r * SEATS_PER_ROW) + c;
                    const student = data[studentIdx];
                    const seatNumber = studentIdx + 1;

                    if (student) {
                        const firstName = (getVal(student, 'ชื่อ') || "").trim();
                        const nickname = (getVal(student, 'ชื่อเล่น') || "").trim();
                        const rank = (getVal(student, 'ยศ') || "").trim();
                        const isFemale = rank.includes("หญิง");
                        const hasDuty = checkDuty(student);
                        const isMatch = filterQuery === '' || seatNumber.toString() === filterQuery || firstName.toLowerCase().includes(filterQuery) || nickname.toLowerCase().includes(filterQuery);
                        
                        let dutyClass = isFemale ? 'border-pink-200' : 'border-blue-200';
                        if (hasDuty) dutyClass = isFemale ? 'on-duty-pink-glow' : 'on-duty-glow';

                        const seatDiv = document.createElement('div');
                        seatDiv.className = `seat-card relative bg-white rounded-xl shadow-sm flex flex-col items-center justify-center p-1.5 cursor-pointer border-2 transition-all ${dutyClass} ${isMatch ? '' : 'opacity-10 grayscale pointer-events-none'}`;
                        
                        const profileImg = getImageUrl(student);
                        seatDiv.innerHTML = `
                            <span class="absolute top-1 left-1.5 text-[8px] text-slate-400 font-black italic">#${seatNumber}</span>
                            <div class="w-10 h-10 md:w-14 md:h-14 rounded-xl overflow-hidden mb-1.5 bg-slate-50 flex items-center justify-center">
                                ${profileImg ? `<img src="${profileImg}" class="w-full h-full object-cover">` : (isFemale ? FEMALE_ICON : MALE_ICON)}
                            </div>
                            <div class="text-[8px] md:text-[10px] font-bold text-center truncate w-full">${nickname || firstName}</div>
                        `;
                        seatDiv.onclick = () => showModal(student, seatNumber, hasDuty, isFemale);
                        grid.appendChild(seatDiv);
                    }
                }
            }
        }

        function showModal(student, seatNum, hasDuty, isFemale) {
            const rank = getVal(student, 'ยศ') || "";
            const firstName = (getVal(student, 'ชื่อ') || "").trim();
            const lastName = (getVal(student, 'นามสกุล') || "").trim();
            const nickname = (getVal(student, 'ชื่อเล่น') || "").trim();
            const phone = getVal(student, 'เบอร์โทร') || getVal(student, 'เบอร์โทรศัพท์') || '-';
            
            // ตรวจสอบหัวข้อ IG แบบละเอียด
            const igIdRaw = [
                getVal(student, 'IG'),
                getVal(student, 'IG Id'),
                getVal(student, 'Instagram'),
                getVal(student, 'ไอจี')
            ].find(val => val && val.toString().trim() !== "");
            
            const igId = igIdRaw ? igIdRaw.toString().trim() : '-';
            
            const pos = getVal(student, 'ตำแหน่ง') || '-';
            const status = getVal(student, 'สถานะ') || '-';
            const message = getVal(student, 'อยากจะบอกอะไรกับเพื่อนๆ') || '-';

            document.getElementById('modalFullName').innerText = `${rank}${firstName} ${lastName}`;
            document.getElementById('modalNickname').innerText = nickname ? `ชื่อเล่น: ${nickname}` : '-';
            document.getElementById('modalPosition').innerText = pos;
            document.getElementById('modalPhone').innerText = phone;
            
            const modalIG = document.getElementById('modalIG');
            if (igId !== '-') {
                const displayIG = igId.startsWith('@') ? igId : `@${igId}`;
                const cleanIG = igId.replace('@', '');
                modalIG.innerHTML = `<a href="https://instagram.com/${cleanIG}" target="_blank" class="hover:underline flex items-center">${displayIG}</a>`;
            } else {
                modalIG.innerText = '-';
            }

            document.getElementById('modalStatus').innerText = status;
            document.getElementById('modalMessage').innerText = message;
            document.getElementById('modalSeatNum').innerText = `ที่นั่ง #${seatNum}`;
            
            const profileImg = getImageUrl(student);
            const modalImg = document.getElementById('modalImg');
            const placeholderIcon = document.getElementById('modalPlaceholderIcon');
            if(profileImg) {
                modalImg.src = profileImg;
                modalImg.classList.remove('hidden');
                placeholderIcon.innerHTML = '';
            } else {
                modalImg.classList.add('hidden');
                placeholderIcon.innerHTML = isFemale ? FEMALE_ICON : MALE_ICON;
            }

            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function refreshData() {
            document.getElementById('refreshIcon').classList.add('refresh-spin');
            initApp();
        }

        function stopRefreshAnimation() {
            document.getElementById('refreshIcon').classList.remove('refresh-spin');
        }

        // Digital Board Logic
        let canvas, ctx, painting = false;

        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            const start = (e) => { painting = true; draw(e); };
            const stop = () => { painting = false; ctx.beginPath(); };
            
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mousemove', draw);
            
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); const t = e.touches[0]; start({clientX: t.clientX, clientY: t.clientY}); });
            canvas.addEventListener('touchend', stop);
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const t = t = e.touches[0]; draw({clientX: t.clientX, clientY: t.clientY}); });
        }

        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            if (!container) return;
            const data = canvas.toDataURL();
            canvas.width = container.clientWidth;
            canvas.height = 400;
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = data;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function draw(e) {
            if (!painting) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = document.getElementById('canvasSize').value;
            ctx.strokeStyle = document.getElementById('canvasColor').value;
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function downloadCanvas() {
            const link = document.createElement('a');
            link.download = `ฝอตร47_บันทึก_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        document.getElementById('searchInput').addEventListener('input', (e) => renderGrid(studentData, e.target.value));
        window.onload = initApp;
    </script>
</body>
</html>
